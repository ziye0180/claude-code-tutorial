---
Claude Code 组件交互全景图

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                           用户输入 (User Input)                              │
  │                    "帮我写一个数据库迁移工具" / "/deploy"                      │
  └─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        📜 Rules 层（始终生效）                                │
  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐                   │
  │  │ CLAUDE.md    │  │ .claude/     │  │ Plugin Settings  │                   │
  │  │ (项目规则)   │  │ settings.json│  │ (.local.md)      │                   │
  │  └──────────────┘  └──────────────┘  └──────────────────┘                   │
  │  - 代码风格约束    - 工具权限配置    - 插件个性化配置                          │
  │  - 项目约定        - 模型选择        - 敏感信息存储                            │
  └─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        🧠 Claude 主进程决策                                   │
  │                                                                             │
  │   输入类型判断：                                                              │
  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
  │   │ 斜杠命令？   │    │ 问题匹配    │    │ 复杂任务？   │                     │
  │   │ /deploy     │    │ Skill触发词？│    │ 需要Agent？  │                     │
  │   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                     │
  │          │                  │                  │                            │
  │          ▼                  ▼                  ▼                            │
  │   执行 Command        加载 Skill          派发 Agent                         │
  └─────────────────────────────────────────────────────────────────────────────┘
                      │              │              │
          ┌───────────┘              │              └───────────┐
          ▼                          ▼                          ▼
  ┌───────────────┐          ┌───────────────┐          ┌───────────────┐
  │ ⚡ Commands    │          │ 📚 Skills     │          │ 🤖 Agents     │
  │               │          │               │          │               │
  │ 用户主动调用   │          │ 自动注入知识   │          │ 自主执行任务   │
  │ /deploy       │          │ 根据问题匹配   │          │ 多步骤处理    │
  │ /docker-init  │          │ 渐进式加载     │          │ 独立上下文    │
  └───────┬───────┘          └───────┬───────┘          └───────┬───────┘
          │                          │                          │
          └──────────────────────────┼──────────────────────────┘
                                     │
                                     ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                          🔧 工具调用 (Tool Use)                               │
  │                                                                             │
  │   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │
  │   │ Read   │ │ Write  │ │ Edit   │ │ Bash   │ │ Glob   │ │ Grep   │        │
  │   └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘        │
  │   ┌────────┐ ┌────────┐ ┌────────────────────────────────────────┐         │
  │   │ Task   │ │ LSP    │ │        MCP Tools (外部服务)            │         │
  │   │(Agent) │ │        │ │  数据库查询 / API调用 / 文件系统等      │         │
  │   └────────┘ └────────┘ └────────────────────────────────────────┘         │
  └─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                          🪝 Hooks 层（事件驱动）                              │
  │                                                                             │
  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐        │
  │   │ PreToolUse      │    │ PostToolUse     │    │ Notification    │        │
  │   │ 工具调用前拦截   │    │ 工具调用后处理   │    │ 通知事件处理     │        │
  │   └─────────────────┘    └─────────────────┘    └─────────────────┘        │
  │                                                                             │
  │   示例：                                                                     │
  │   - 写文件前自动格式化检查                                                    │
  │   - Git commit 后自动推送通知                                                │
  │   - 敏感操作前弹出确认                                                       │
  └─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                              📤 输出给用户                                    │
  └─────────────────────────────────────────────────────────────────────────────┘

  ---
  🔄 各组件触发时机对比

  | 组件     | 触发时机             | 触发方式               | 生命周期               |
  |----------|----------------------|------------------------|------------------------|
  | Rules    | 每次对话开始         | 自动加载               | 整个会话持续           |
  | Skills   | 用户问题匹配触发词   | Claude 自动判断        | 按需加载，用完释放     |
  | Commands | 用户输入 /xxx        | 用户主动               | 单次执行               |
  | Agents   | 复杂任务需要自主处理 | Claude 派发 / 用户请求 | 独立子进程，完成后返回 |
  | Hooks    | 特定事件发生时       | 事件驱动               | 事件触发时执行         |
  | MCP      | 需要外部服务时       | 工具调用               | 按需连接               |

  ---
  🎯 最佳实践流程（以实际任务为例）

  场景：用户说 "帮我给这个项目加上 Docker 部署"

  1️⃣ Rules 生效
     └─> CLAUDE.md 告诉 Claude：使用 docker compose（不是 docker-compose）

  2️⃣ Skill 匹配
     └─> 检测到关键词 "Docker"，加载 docker-assistant skill
     └─> Skill 提供：Dockerfile 最佳实践、多阶段构建模式等知识

  3️⃣ Claude 分析任务
     └─> 判断项目类型（Next.js / Spring Boot）
     └─> 决定需要生成哪些文件

  4️⃣ 工具调用
     ├─> Glob：查找项目结构
     ├─> Read：读取 package.json / pom.xml
     └─> Write：生成 Dockerfile + docker-compose.yaml

  5️⃣ Hooks 触发（如果配置了）
     └─> PostToolUse(Write)：自动运行 docker compose config 验证配置

  6️⃣ 返回结果
     └─> 向用户展示生成的文件和使用说明

  ---
  💡 核心原则总结

  ┌─────────────────────────────────────────────────────────────┐
  │                    Claude Code 设计哲学                      │
  ├─────────────────────────────────────────────────────────────┤
  │  🎯 最小干预：Rules 始终在后台约束，不需要用户操心            │
  │  📚 按需加载：Skills 只在需要时注入，避免上下文爆炸           │
  │  ⚡ 显式触发：Commands 让用户掌握主动权                       │
  │  🤖 自主执行：Agents 处理复杂任务，减轻主进程负担             │
  │  🪝 事件驱动：Hooks 实现自动化，无需手动干预                  │
  │  🔌 外部扩展：MCP 连接一切外部服务                           │
  └─────────────────────────────────────────────────────────────┘

  ---
  🤔 你想深入哪个方向？

  1. Skill 触发机制 - 如何写出能被精准匹配的触发描述
  2. Agent 派发逻辑 - 什么时候该用 Agent vs 直接执行
  3. Hooks 事件流 - 详细的事件类型和拦截点
  4. 组件协作案例 - 用你的 ziye-cc-plugin-market 做实战演示

  告诉我你最想搞懂的部分，我们继续深挖！🔥
---
