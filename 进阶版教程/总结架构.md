# Claude Code 深度架构解析

> 本文从底层逻辑角度，系统性地解析 Claude Code 的组件架构、交互机制和最佳实践。

---

## 目录

1. [核心设计哲学](#核心设计哲学)
2. [记忆层级体系](#记忆层级体系)
3. [组件全景图](#组件全景图)
4. [各组件深度解析](#各组件深度解析)
5. [组件交互流程](#组件交互流程)
6. [最佳实践指南](#最佳实践指南)

---

## 核心设计哲学

Claude Code 的设计遵循以下核心原则：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Claude Code 设计哲学                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  🎯 最小干预原则                                                             │
│     Rules/CLAUDE.md 始终在后台约束行为，用户无需主动管理                       │
│                                                                             │
│  📚 按需加载原则                                                             │
│     Skills 只在问题匹配时注入，避免上下文窗口爆炸                              │
│                                                                             │
│  ⚡ 显式触发原则                                                             │
│     Commands 让用户掌握主动权，明确知道触发了什么                              │
│                                                                             │
│  🤖 自主执行原则                                                             │
│     Agents 处理复杂多步骤任务，拥有独立上下文                                  │
│                                                                             │
│  🪝 事件驱动原则                                                             │
│     Hooks 在特定事件时自动执行，实现无感自动化                                 │
│                                                                             │
│  🔌 外部扩展原则                                                             │
│     MCP 提供标准化接口，连接一切外部服务                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 记忆层级体系

Claude Code 的记忆系统采用**分层架构**，优先级从高到低依次为：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              记忆层级金字塔                                   │
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │  Enterprise     │  ← 最高优先级                    │
│                         │  Policy         │    企业级策略（托管部署）          │
│                         └────────┬────────┘                                 │
│                    ┌─────────────┴─────────────┐                            │
│                    │   .claude/rules/*.md      │  ← 项目模块化规则           │
│                    │   (路径条件加载)           │    支持 paths 匹配          │
│                    └─────────────┬─────────────┘                            │
│               ┌──────────────────┴──────────────────┐                       │
│               │      .claude/CLAUDE.md              │  ← 项目主指导文件       │
│               │      项目根目录/CLAUDE.md            │                        │
│               └──────────────────┬──────────────────┘                       │
│          ┌───────────────────────┴───────────────────────┐                  │
│          │           ~/.claude/CLAUDE.md                 │  ← 用户全局偏好   │
│          │           用户级别的全局配置                    │                  │
│          └───────────────────────┬───────────────────────┘                  │
│     ┌────────────────────────────┴────────────────────────────┐             │
│     │              .claude.local.md                           │  ← 最低优先级│
│     │              本地私有配置（不提交到 Git）                  │             │
│     └─────────────────────────────────────────────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 各层级详解

| 层级 | 文件位置 | 作用范围 | 是否提交 Git | 典型用途 |
|------|----------|----------|-------------|----------|
| **Enterprise** | 托管服务配置 | 组织全局 | N/A | 安全策略、合规要求 |
| **Rules** | `.claude/rules/*.md` | 项目级(条件) | ✅ | 分模块的项目规范 |
| **Project** | `.claude/CLAUDE.md` | 项目级 | ✅ | 项目通用指导 |
| **User** | `~/.claude/CLAUDE.md` | 用户全局 | ❌ | 个人偏好、工具链 |
| **Local** | `.claude.local.md` | 项目本地 | ❌ | 敏感信息、临时配置 |

### Rules 新机制详解

**这是 Claude Code 的重要新特性！**

```
项目根目录/
├── .claude/
│   ├── CLAUDE.md                    # 主项目指导（始终加载）
│   └── rules/                       # 模块化规则目录
│       ├── code-style.md            # 代码风格（始终加载）
│       ├── testing.md               # 测试规范（始终加载）
│       ├── frontend/
│       │   └── react.md             # 可配置 paths 条件
│       └── backend/
│           └── api.md               # 可配置 paths 条件
```

**路径条件加载语法：**

```markdown
---
paths: src/api/**/*.ts
---

# API 开发规则

仅当操作 src/api/ 下的 TypeScript 文件时，此规则才会被加载到上下文。

- 所有端点必须包含输入验证
- 使用标准错误响应格式
- 添加 OpenAPI 文档注释
```

**支持的 Glob 模式：**

| 模式 | 匹配对象 |
|------|---------|
| `**/*.ts` | 任意目录下的所有 `.ts` 文件 |
| `src/**/*` | `src/` 下所有文件 |
| `*.md` | 根目录的 Markdown 文件 |
| `src/components/*.tsx` | 特定目录的 React 组件 |
| `{src,lib}/**/*.ts` | 多目录匹配 |

---

## 组件全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户输入 (User Input)                              │
│                    "帮我写一个数据库迁移工具" / "/deploy"                      │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     📜 记忆层（自动加载到上下文）                              │
│                                                                             │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────────┐│
│  │ CLAUDE.md      │  │ Rules          │  │ Settings                       ││
│  │ (项目+用户)    │  │ (.claude/rules)│  │ (.claude/settings.json)        ││
│  └────────────────┘  └────────────────┘  └────────────────────────────────┘│
│                                                                             │
│  作用：定义行为边界、代码风格、项目约定、工具权限等                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        🧠 Claude 主进程决策层                                 │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         输入类型判断                                 │  │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐   │  │
│   │  │ 斜杠命令？     │  │ 问题匹配       │  │ 复杂任务？             │   │  │
│   │  │ /deploy       │  │ Skill 触发词？ │  │ 需要 Agent？           │   │  │
│   │  │ /commit       │  │ "Docker"       │  │ 多步骤自主处理？        │   │  │
│   │  └───────┬───────┘  └───────┬───────┘  └───────────┬───────────┘   │  │
│   │          │                  │                      │               │  │
│   │          ▼                  ▼                      ▼               │  │
│   │   执行 Command        加载 Skill              派发 Agent           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                    │              │              │
        ┌───────────┘              │              └───────────┐
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│ ⚡ Commands    │          │ 📚 Skills     │          │ 🤖 Agents     │
│               │          │               │          │               │
│ 用户显式调用   │          │ 自动匹配加载   │          │ 自主子进程     │
│ /deploy       │          │ 领域知识注入   │          │ 独立上下文     │
│ /docker-init  │          │ 渐进式披露     │          │ 多步骤执行     │
│ /commit       │          │ references/   │          │ 任务完成返回   │
└───────┬───────┘          └───────┬───────┘          └───────┬───────┘
        │                          │                          │
        └──────────────────────────┼──────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          🔧 工具层 (Tool Use)                                │
│                                                                             │
│   内置工具：                                                                 │
│   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │
│   │ Read   │ │ Write  │ │ Edit   │ │ Bash   │ │ Glob   │ │ Grep   │        │
│   └────────┘ └────────┘ └────────┘ └────────┘ └────────┘ └────────┘        │
│   ┌────────┐ ┌────────┐ ┌────────┐ ┌────────────────┐                      │
│   │ Task   │ │ LSP    │ │WebFetch│ │ TodoWrite      │                      │
│   │(Agent) │ │        │ │        │ │                │                      │
│   └────────┘ └────────┘ └────────┘ └────────────────┘                      │
│                                                                             │
│   MCP 扩展工具：                                                             │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │  数据库查询 │ API 调用 │ 文件系统 │ 浏览器操作 │ 自定义服务 ...      │   │
│   └────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                          ┌───────┴───────┐
                          ▼               ▼
              ┌─────────────────┐  ┌─────────────────┐
              │ 🪝 PreToolUse   │  │ 🪝 PostToolUse  │
              │ 工具调用前拦截   │  │ 工具调用后处理   │
              └─────────────────┘  └─────────────────┘
                          │               │
                          └───────┬───────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          🪝 Hooks 层（事件驱动）                              │
│                                                                             │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│   │ PreToolUse      │  │ PostToolUse     │  │ Notification    │            │
│   │                 │  │                 │  │                 │            │
│   │ - 权限校验       │  │ - 格式化检查     │  │ - 进度通知       │            │
│   │ - 参数验证       │  │ - 自动测试       │  │ - 错误告警       │            │
│   │ - 敏感操作确认   │  │ - 日志记录       │  │ - 完成提醒       │            │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
│   ┌─────────────────┐  ┌─────────────────┐                                 │
│   │ Stop            │  │ SubagentStop    │                                 │
│   │ 会话结束时       │  │ 子代理结束时     │                                 │
│   └─────────────────┘  └─────────────────┘                                 │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              📤 输出给用户                                    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 各组件深度解析

### 1. Rules / CLAUDE.md（记忆层）

**本质**：为 Claude 提供持久化的行为指导和约束

**加载时机**：每次对话开始时自动加载

**生命周期**：整个会话持续生效

```
┌─────────────────────────────────────────────────────────────────┐
│                    Rules vs CLAUDE.md 对比                       │
├────────────────┬────────────────────┬───────────────────────────┤
│ 维度           │ CLAUDE.md          │ Rules (.claude/rules/)    │
├────────────────┼────────────────────┼───────────────────────────┤
│ 存储方式       │ 单个文件            │ 多个文件，支持子目录        │
│ 加载方式       │ 始终全量加载        │ 支持 paths 条件加载        │
│ 组织结构       │ 单体，所有内容一起   │ 模块化，按主题拆分         │
│ 典型用途       │ 通用项目指导        │ 特定领域/路径的规则        │
│ 跨项目共享     │ 不支持              │ 支持符号链接共享           │
└────────────────┴────────────────────┴───────────────────────────┘
```

### 2. Skills（知识注入层）

**本质**：为 Claude 注入特定领域的专业知识

**加载时机**：用户问题匹配到触发词时自动加载

**生命周期**：按需加载，任务完成后释放

```
Skills 目录结构：
skills/
└── docker-assistant/
    ├── SKILL.md              # 核心技能描述（1500-2000 词）
    ├── references/           # 详细参考资料（按需读取）
    │   ├── dockerfile-patterns.md
    │   └── compose-best-practices.md
    ├── examples/             # 示例代码
    │   ├── nextjs/
    │   └── springboot/
    └── scripts/              # 工具脚本
        └── validate-config.sh
```

**SKILL.md 写作规范**：

```markdown
---
# 技能元数据（可选）
---

# 描述部分（第三人称，包含触发词）
This skill helps Claude assist users with Docker containerization.
It activates when users ask about "Docker", "Dockerfile", "container",
"docker compose", or "containerization".

# 正文部分（祈使句，精炼）
## Core Principles

Use multi-stage builds for production images...

## Reference Files

For detailed Dockerfile patterns, read `references/dockerfile-patterns.md`.
```

### 3. Commands（用户命令层）

**本质**：用户通过 `/xxx` 显式触发的预定义任务

**加载时机**：用户输入斜杠命令时

**生命周期**：单次执行

```markdown
---
description: "Generate Docker configuration for the project"
argument-hint: "[framework]"
allowed-tools: ["Read", "Write", "Glob", "Bash"]
---

# 指令内容（写给 Claude，不是写给用户）

Analyze the current project structure to determine the framework type.

1. Check for package.json (Node.js/Next.js)
2. Check for pom.xml or build.gradle (Java/Spring Boot)
3. Check for requirements.txt or pyproject.toml (Python)

Based on the detected framework, generate appropriate:
- Dockerfile (multi-stage build)
- docker-compose.yaml (dev + prod)
- .dockerignore

Use the templates from the docker-assistant skill if available.
```

### 4. Agents（自主执行层）

**本质**：拥有独立上下文的子进程，可自主完成复杂多步骤任务

**加载时机**：
- Claude 主进程判断任务复杂度后派发
- 用户显式请求
- 满足 `whenToUse` 条件时自动触发

**生命周期**：独立子进程，任务完成后返回结果给主进程

```
Agent 类型：
┌─────────────────────────────────────────────────────────────────┐
│  内置 Agent                                                      │
├─────────────────────────────────────────────────────────────────┤
│  general-purpose   │ 通用代理，处理复杂多步骤任务                 │
│  Explore           │ 代码库探索，快速搜索和理解代码                │
│  Plan              │ 架构设计，制定实现计划                       │
│  claude-code-guide │ Claude Code 文档查询                        │
├─────────────────────────────────────────────────────────────────┤
│  自定义 Agent                                                    │
├─────────────────────────────────────────────────────────────────┤
│  通过 .claude/agents/*.md 定义                                   │
│  包含：identifier, whenToUse, systemPrompt, tools, model        │
└─────────────────────────────────────────────────────────────────┘
```

**自定义 Agent 示例**：

```markdown
---
identifier: code-reviewer
whenToUse: |
  Use this agent after completing significant code changes.
  <example>
  user: "I've finished implementing the authentication module"
  assistant: [Triggers code-reviewer agent]
  </example>
model: sonnet
tools: ["Read", "Glob", "Grep"]
---

# Code Review Agent

You are a code review specialist. Your task is to:

1. Analyze the changed files for potential issues
2. Check for security vulnerabilities
3. Verify code style consistency
4. Suggest improvements

Provide a structured review report.
```

### 5. Hooks（事件驱动层）

**本质**：在特定事件发生时自动执行的脚本或提示

**加载时机**：事件触发时

**生命周期**：事件处理期间

```
Hooks 事件类型：
┌─────────────────────────────────────────────────────────────────┐
│  事件名称          │ 触发时机                │ 典型用途          │
├────────────────────┼─────────────────────────┼───────────────────┤
│  PreToolUse        │ 工具调用前              │ 权限校验、参数验证 │
│  PostToolUse       │ 工具调用后              │ 格式化、测试、日志 │
│  Notification      │ 通知事件                │ 进度提示、告警    │
│  Stop              │ 会话结束                │ 清理、总结        │
│  SubagentStop      │ 子代理结束              │ 结果处理          │
└─────────────────────────────────────────────────────────────────┘
```

**hooks.json 配置示例**：

```json
{
  "hooks": [
    {
      "event": "PostToolUse",
      "matcher": {
        "tool_name": "Write",
        "file_path": "**/*.ts"
      },
      "command": "cd $PLUGIN_DIR && npx eslint --fix $FILE_PATH",
      "timeout": 30000
    },
    {
      "event": "PreToolUse",
      "matcher": {
        "tool_name": "Bash"
      },
      "prompt": "Before executing this command, verify it doesn't contain destructive operations like rm -rf or format commands."
    }
  ]
}
```

### 6. MCP（外部扩展层）

**本质**：Model Context Protocol，标准化的外部服务连接协议

**加载时机**：需要外部服务时

**生命周期**：按需连接

```
MCP 服务器类型：
┌─────────────────────────────────────────────────────────────────┐
│  类型      │ 传输方式    │ 典型场景                              │
├────────────┼─────────────┼───────────────────────────────────────┤
│  stdio     │ 标准输入输出 │ 本地工具、CLI 封装                    │
│  SSE       │ HTTP 流      │ 远程服务、云端 API                    │
└────────────┴─────────────┴───────────────────────────────────────┘
```

**.mcp.json 配置示例**：

```json
{
  "mcpServers": {
    "database": {
      "type": "stdio",
      "command": "node",
      "args": ["$PLUGIN_DIR/mcp-servers/db-server.js"],
      "env": {
        "DATABASE_URL": "${DATABASE_URL}"
      }
    },
    "browser": {
      "type": "sse",
      "url": "https://mcp.example.com/browser",
      "headers": {
        "Authorization": "Bearer ${API_KEY}"
      }
    }
  }
}
```

---

## 组件交互流程

### 完整请求处理流程

```
用户输入: "帮我给这个 Next.js 项目配置 Docker 部署"
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 1: 记忆层加载                                               │
├─────────────────────────────────────────────────────────────────┤
│ ✓ ~/.claude/CLAUDE.md          → 用户全局偏好                    │
│ ✓ .claude/CLAUDE.md            → 项目指导                        │
│ ✓ .claude/rules/docker.md      → Docker 相关规则（如果存在）      │
│ ✓ .claude/settings.json        → 工具权限配置                    │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 2: Claude 主进程分析                                        │
├─────────────────────────────────────────────────────────────────┤
│ 1. 解析用户意图：配置 Docker 部署                                 │
│ 2. 检测关键词："Docker" → 尝试匹配 Skill                          │
│ 3. 判断任务复杂度：中等（需要多个文件，但流程清晰）                 │
│ 4. 决策：加载 Skill + 直接执行（无需派发 Agent）                   │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 3: Skill 加载                                               │
├─────────────────────────────────────────────────────────────────┤
│ 匹配: docker-assistant skill                                     │
│ 加载: SKILL.md 核心内容                                          │
│ 注入: Dockerfile 最佳实践、多阶段构建模式、Compose 配置模板        │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 4: 工具调用（可能触发 Hooks）                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ [Glob] 查找项目结构                                               │
│    │                                                             │
│    ▼                                                             │
│ [Read] package.json → 确认 Next.js 项目                          │
│    │                                                             │
│    ▼                                                             │
│ [Write] Dockerfile                                               │
│    │                                                             │
│    ├─→ [PreToolUse Hook] 检查是否有敏感信息                       │
│    │                                                             │
│    └─→ [PostToolUse Hook] 运行 docker build --check              │
│    │                                                             │
│    ▼                                                             │
│ [Write] docker-compose.yaml                                      │
│    │                                                             │
│    └─→ [PostToolUse Hook] 运行 docker compose config             │
│    │                                                             │
│    ▼                                                             │
│ [Write] .dockerignore                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 5: 返回结果                                                 │
├─────────────────────────────────────────────────────────────────┤
│ 输出：                                                           │
│ - 生成的文件列表                                                  │
│ - 使用说明                                                       │
│ - 后续建议（如配置 CI/CD）                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 组件协作决策树

```
                              用户输入
                                 │
                    ┌────────────┴────────────┐
                    │                         │
              是斜杠命令？                  自然语言？
                    │                         │
                    ▼                         ▼
              执行 Command            ┌───────┴───────┐
                                      │               │
                              匹配 Skill？      不匹配
                                      │               │
                                      ▼               ▼
                              加载 Skill        直接处理
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
              简单任务？         中等任务？        复杂任务？
                    │                 │                 │
                    ▼                 ▼                 ▼
              直接工具调用      主进程处理        派发 Agent
              (Read/Write)    (多工具组合)      (Task tool)
                    │                 │                 │
                    └─────────────────┴─────────────────┘
                                      │
                                      ▼
                              Hooks 拦截/处理
                                      │
                                      ▼
                                 输出结果
```

---

## 最佳实践指南

### 1. 记忆层组织最佳实践

```bash
# 推荐的项目结构
your-project/
├── .claude/
│   ├── CLAUDE.md                    # 项目通用指导
│   ├── settings.json                # 工具权限配置
│   └── rules/                       # 模块化规则
│       ├── general.md               # 通用规则（无 paths）
│       ├── frontend/
│       │   └── react.md             # paths: src/**/*.tsx
│       └── backend/
│           └── api.md               # paths: api/**/*.ts
├── .claude.local.md                 # 本地私有配置（.gitignore）
└── ...
```

### 2. Skill 设计最佳实践

| 原则 | 说明 |
|------|------|
| **渐进式披露** | SKILL.md 保持精炼（1500-2000 词），详细内容放 references/ |
| **强触发词** | 描述中包含明确的触发词，避免误触发 |
| **第三人称描述** | "This skill helps Claude..." 而非 "Help users..." |
| **祈使句正文** | "Use X to...", "Check Y..." |

### 3. Agent 使用决策

```
何时使用 Agent？

✅ 使用 Agent:
- 任务需要多轮探索和决策
- 需要独立的上下文隔离
- 任务可能需要长时间运行
- 需要并行处理多个独立子任务

❌ 不使用 Agent:
- 简单的单文件修改
- 明确知道要做什么的直接操作
- 需要保持主对话上下文的任务
```

### 4. Hooks 设计原则

```
Hook 类型选择：

command 类型：
- 简单的脚本执行
- 外部工具调用
- 文件操作

prompt 类型：
- 需要 Claude 理解和判断
- 复杂的验证逻辑
- 需要上下文感知的处理
```

---

## 总结对比表

| 组件 | 触发方式 | 生命周期 | 上下文 | 主要用途 |
|------|----------|----------|--------|----------|
| **Rules** | 自动（条件可选） | 会话持续 | 主进程 | 行为约束、项目规范 |
| **CLAUDE.md** | 自动 | 会话持续 | 主进程 | 通用指导 |
| **Skills** | 问题匹配 | 按需加载 | 主进程 | 领域知识注入 |
| **Commands** | /xxx 显式 | 单次执行 | 主进程 | 预定义任务 |
| **Agents** | 派发/请求 | 任务周期 | 独立 | 复杂多步骤任务 |
| **Hooks** | 事件触发 | 事件周期 | 独立 | 自动化流程 |
| **MCP** | 工具调用 | 按需连接 | 主进程 | 外部服务扩展 |

---

## 下一步

- [Skills 开发指南](./02-skills-development.md)
- [Commands 开发指南](./03-commands-development.md)
- [Agents 开发指南](./04-agents-development.md)
- [Hooks 开发指南](./05-hooks-development.md)
- [MCP 集成指南](./06-mcp-integration.md)
- [插件打包与发布](./07-plugin-packaging.md)
